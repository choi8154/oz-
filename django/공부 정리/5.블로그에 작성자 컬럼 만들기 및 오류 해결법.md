# blog model 설정

### 1) 외례키 설정 방법
- 외래키를 만들기
```python
from django.db import models
from django.contrib.auth import get_user_model

class Blog(models.Model):
    CATEGORY_CHOICES = (
        ('cat','고양이'),
        ('dog','강아지'),
        ('bird','새'),
        ('fish','물고기'),
    )
    category = models.CharField('카테고리',max_length=10, choices=CATEGORY_CHOICES)
    title = models.CharField('제목'max_lenght=100)
    context = models.TextField('본문')
    # 이런식으로 포린키를 만듦
    author = models.ForeignKey(User, on_delete=models.CASCADE)
    created_at = models.DateTimeField(auto_now_add=True)
    update_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"[{self.get_category_display}] {self.title[:10]}"
```

### 2) 템플릿 base.html 만들어 적용하기
- base.html 상속 : {% extends 'base.html' %}
- 블럭으로 지정 : {% block content %} 내용 {% endblock %}


### 3) 블로그에 forms 만들기 (블로그 포스팅 페이지)
- 폼을 만들기 : blog폴더에 forms.py 만들기
```python
from django import forms
from blog.models import Blog

class BlogForm(forms.ModelForm):
    class Meta:
        model = Blog
        fields = ['title', 'content']
```


### 4) 블로그 포스팅 페이지 만들기
- blog/views에 엔드포인트 함수 만들기
```python
import django.shortcuts import render,
import django.urls import redirect
import blog.forms import BlogForm

...
def blog_create(request):
    form = BlogForm(request.POST or None)
    if form.is_valid():
        blog = form.save(commit=false)
        blog.author = request.user
        blog.save()
        return redirect('blog_list', kwargs={'pk'=blog.pk})
    context = {
        'form':form
    }
    return render(request, 'blog_create.html', context)
```
- urls에 등록하기
```python
from urls import path

from blog import views

urlpatterns = [
    ...,
    path('create/', views.blog_create, name=blog_create)
]
```

- html 만들기
```html
{% extends 'base.html' %}
{% block content %}
<h1>블로그 작성</h1>
<form method="POST">
    {% csrf_token %}
    {{ form.as_p }}
    <button>submit</button>
{% endblock %}

```

### 5) 로그인 되지 않은 유저일 시 엔포 접근 못하게 하는 방법
- 직접 코드로 쓰는 방법
```python
def blog_detail(request):
    if not request.user.is_authenticated:
        return redirect("login")
```

- 내장 오버라이딩 기능 사용 : settings.py 의 LOGIN_URL로 리다이렉트 됨.
```python
from django.contrib.auth.decorators import login_required

@login_required()
def ...
```

### 6) 로그인 된 후 바로 해당 페이지로 하게하기
- 로그인 하지 않고 해당 페이지에 가면 로그인 페이지로 리다이렉트 되는데  
"http://127.0.0.1:8000/login/?next=/create/" url에 next key값이 남음
- 이걸 이용해서 정상 로그인 후 해당 페이지로 넘어갈 수 있음
```python
def login(request):
    ...
    next = request.GET.get('next'): #request.GET['next']로 하면 None 값을 오류로 주기 때문에 get()사용
    if next:
        return redirect(next)
```
